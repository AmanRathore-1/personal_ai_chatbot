{"version":3,"sources":["../../../src/utils/tap-store/derived-scopes.ts"],"sourcesContent":["import { resource, tapEffect } from \"@assistant-ui/tap\";\nimport { tapMemo, tapRef, tapResource, tapResources } from \"@assistant-ui/tap\";\nimport { createAssistantApiField } from \"../../context/react/AssistantApiContext\";\nimport type {\n  AssistantApi,\n  AssistantApiField,\n} from \"../../context/react/AssistantApiContext\";\nimport type {\n  AssistantEvent,\n  AssistantEventCallback,\n  AssistantEventSelector,\n} from \"../../types/EventTypes\";\nimport type { ResourceElement, Unsubscribe } from \"@assistant-ui/tap\";\n\n/**\n * Extract the API return type from an AssistantApiField\n */\ntype ExtractApiType<T> =\n  T extends AssistantApiField<infer TApi, any> ? TApi : never;\n\n/**\n * Extract the metadata type from an AssistantApiField\n *\n * Used in DerivedScopesInput to validate that each field's source/query types match\n * the expected types from AssistantApi.\n */\ntype ExtractMeta<T> =\n  T extends AssistantApiField<any, infer TMeta> ? TMeta : never;\n\n/**\n * Get only the field names from AssistantApi (exclude method names)\n */\ntype AssistantApiFieldNames = {\n  [K in keyof AssistantApi]: AssistantApi[K] extends { source: any; query: any }\n    ? K\n    : never;\n}[keyof AssistantApi];\n\n/**\n * Configuration for a derived scope field - infers types from the actual values provided\n */\nexport type DerivedScopeConfig<TSource extends string | null, TQuery, TApi> = {\n  source: TSource;\n  query: TQuery;\n  get: () => TApi;\n};\n\n/**\n * Type for the special `on` callback function\n */\nexport type OnCallbackFn = <TEvent extends AssistantEvent>(\n  selector: AssistantEventSelector<TEvent>,\n  callback: AssistantEventCallback<TEvent>,\n) => Unsubscribe;\n\n/**\n * Type for the special `subscribe` callback function\n */\nexport type SubscribeCallbackFn = (listener: () => void) => Unsubscribe;\n\n/**\n * Type for the special `flushSync` callback function\n */\nexport type FlushSyncCallbackFn = () => void;\n\n/**\n * Type for special non-field functions in AssistantApi\n */\nexport type SpecialCallbacks = {\n  on?: OnCallbackFn;\n  subscribe?: SubscribeCallbackFn;\n  flushSync?: FlushSyncCallbackFn;\n};\n\n/**\n * Type for the scopes parameter - allows both DerivedScope elements and special callbacks.\n * Field names are restricted to valid AssistantApi field names.\n * TypeScript validates that the source/query/get types match the expected field type.\n */\nexport type DerivedScopesInput = {\n  [K in AssistantApiFieldNames]?: ResourceElement<\n    AssistantApiField<\n      ExtractApiType<AssistantApi[K]>,\n      {\n        source: ExtractMeta<AssistantApi[K]>[\"source\"];\n        query: ExtractMeta<AssistantApi[K]>[\"query\"];\n      }\n    >\n  >;\n} & SpecialCallbacks;\n\n/**\n * DerivedScope resource - memoizes an AssistantApiField based on source and query.\n * The get callback always calls the most recent version (useEffectEvent pattern).\n * TypeScript infers TSource, TQuery, and TApi from the config object.\n * Validation happens at the DerivedScopesInput level.\n */\nexport const DerivedScope = resource(\n  <TSource extends string | null, TQuery, TApi>(\n    config: DerivedScopeConfig<TSource, TQuery, TApi>,\n  ): AssistantApiField<\n    TApi,\n    {\n      source: TSource;\n      query: TQuery;\n    }\n  > => {\n    const getRef = tapRef(config.get);\n    tapEffect(() => {\n      getRef.current = config.get;\n    });\n\n    return tapMemo(() => {\n      return createAssistantApiField({\n        source: config.source,\n        query: config.query,\n        get: () => getRef.current(),\n      });\n    }, [config.source, JSON.stringify(config.query)]);\n  },\n);\n\n/**\n * Helper resource to wrap each scope field - stable resource identity for proper memoization.\n * Creating this outside the map ensures tapResources can properly track and memoize each field.\n */\nconst ScopeFieldWithNameResource = resource(\n  (config: {\n    fieldName: string;\n    scopeElement: ReturnType<typeof DerivedScope>;\n  }) => {\n    const field = tapResource(config.scopeElement);\n    return tapMemo(\n      () => [config.fieldName, field] as const,\n      [config.fieldName, field],\n    );\n  },\n);\n\n/**\n * DerivedScopes resource - takes an object of DerivedScope resource elements and special callbacks,\n * and returns a Partial<AssistantApi> with all the derived fields.\n */\nexport const DerivedScopes = resource(\n  (scopes: DerivedScopesInput): Partial<AssistantApi> => {\n    const { on, subscribe, flushSync, ...scopeFields } = scopes;\n    const callbacksRef = tapRef({ on, subscribe, flushSync });\n    tapEffect(() => {\n      callbacksRef.current = { on, subscribe, flushSync };\n    });\n\n    const results = tapResources(\n      Object.entries(scopeFields).map(([fieldName, scopeElement]) =>\n        ScopeFieldWithNameResource(\n          {\n            fieldName,\n            scopeElement: scopeElement as ReturnType<typeof DerivedScope>,\n          },\n          { key: fieldName },\n        ),\n      ),\n    );\n\n    return tapMemo(() => {\n      const result = Object.fromEntries(results) as Partial<AssistantApi>;\n\n      const {\n        on: onCb,\n        subscribe: subCb,\n        flushSync: flushCb,\n      } = callbacksRef.current;\n\n      if (onCb) {\n        result.on = <TEvent extends AssistantEvent>(\n          selector: AssistantEventSelector<TEvent>,\n          callback: AssistantEventCallback<TEvent>,\n        ) => onCb(selector, callback);\n      }\n      if (subCb) result.subscribe = (listener) => subCb(listener);\n      if (flushCb) result.flushSync = () => flushCb();\n\n      return result;\n    }, [...results]);\n  },\n);\n"],"mappings":";AAAA,SAAS,UAAU,iBAAiB;AACpC,SAAS,SAAS,QAAQ,aAAa,oBAAoB;AAC3D,SAAS,+BAA+B;AA+FjC,IAAM,eAAe;AAAA,EAC1B,CACE,WAOG;AACH,UAAM,SAAS,OAAO,OAAO,GAAG;AAChC,cAAU,MAAM;AACd,aAAO,UAAU,OAAO;AAAA,IAC1B,CAAC;AAED,WAAO,QAAQ,MAAM;AACnB,aAAO,wBAAwB;AAAA,QAC7B,QAAQ,OAAO;AAAA,QACf,OAAO,OAAO;AAAA,QACd,KAAK,MAAM,OAAO,QAAQ;AAAA,MAC5B,CAAC;AAAA,IACH,GAAG,CAAC,OAAO,QAAQ,KAAK,UAAU,OAAO,KAAK,CAAC,CAAC;AAAA,EAClD;AACF;AAMA,IAAM,6BAA6B;AAAA,EACjC,CAAC,WAGK;AACJ,UAAM,QAAQ,YAAY,OAAO,YAAY;AAC7C,WAAO;AAAA,MACL,MAAM,CAAC,OAAO,WAAW,KAAK;AAAA,MAC9B,CAAC,OAAO,WAAW,KAAK;AAAA,IAC1B;AAAA,EACF;AACF;AAMO,IAAM,gBAAgB;AAAA,EAC3B,CAAC,WAAsD;AACrD,UAAM,EAAE,IAAI,WAAW,WAAW,GAAG,YAAY,IAAI;AACrD,UAAM,eAAe,OAAO,EAAE,IAAI,WAAW,UAAU,CAAC;AACxD,cAAU,MAAM;AACd,mBAAa,UAAU,EAAE,IAAI,WAAW,UAAU;AAAA,IACpD,CAAC;AAED,UAAM,UAAU;AAAA,MACd,OAAO,QAAQ,WAAW,EAAE;AAAA,QAAI,CAAC,CAAC,WAAW,YAAY,MACvD;AAAA,UACE;AAAA,YACE;AAAA,YACA;AAAA,UACF;AAAA,UACA,EAAE,KAAK,UAAU;AAAA,QACnB;AAAA,MACF;AAAA,IACF;AAEA,WAAO,QAAQ,MAAM;AACnB,YAAM,SAAS,OAAO,YAAY,OAAO;AAEzC,YAAM;AAAA,QACJ,IAAI;AAAA,QACJ,WAAW;AAAA,QACX,WAAW;AAAA,MACb,IAAI,aAAa;AAEjB,UAAI,MAAM;AACR,eAAO,KAAK,CACV,UACA,aACG,KAAK,UAAU,QAAQ;AAAA,MAC9B;AACA,UAAI,MAAO,QAAO,YAAY,CAAC,aAAa,MAAM,QAAQ;AAC1D,UAAI,QAAS,QAAO,YAAY,MAAM,QAAQ;AAE9C,aAAO;AAAA,IACT,GAAG,CAAC,GAAG,OAAO,CAAC;AAAA,EACjB;AACF;","names":[]}